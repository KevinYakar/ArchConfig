#!/bin/bash

cd ~/ArchConfig
[[ "" == $( pacman -Qqs | grep '^go-rainbow-git$' ) ]] && echo "You don't have rainbow installed. Go install it!" && exit 

printArray () {
    arr=("$@")
    (( ${#arr[@]} == 0 )) && echo "none" && return
    for item in ${arr[@]};
    do
        echo $item
    done
}

# find differences from last commit
differences=($(git diff $(git log | grep commit | head -n 2 | tail -n 1 | sed -e "s/commit //g") | grep -E '^diff|\-\-\- \/dev\/null|\+\+\+ \/dev\/null' | sed -e "s/^diff.* b\///" -e "s/^\+.*/deleted/g" -e "s/^\-.*/added/g"))

add=()
delete=()
modify=()

# add appropriate files to the right arrays
idx=0
while (( $idx < ${#differences[@]} ));
do
    current=${differences[$idx]}
    next=${differences[(( $idx + 1 ))]}

    case $next in
        added)
            add+=($current)
            ;;

        deleted)
            delete+=($current)
            ;;

        *)
            [ -z "$next" ] && [ $current != "added" ] && [ $current != "deleted" ] && modify+=($current)
            [ -n "$next" ] && [ $next != "added" ] && [ $next != "deleted" ] && [ $current != "added" ] && [ $current != "deleted" ] && modify+=($current)
            ;;
    esac
    idx=$(( idx + 1 ))
done

echo -e "=====Added=====" | rainbow
printArray "${add[@]}"
echo

echo -e "=====Deleted=====" | rainbow
printArray "${delete[@]}"
echo

echo -e "=====Modified=====" | rainbow
printArray "${modify[@]}"
echo

echo -n 'Apply changes? [Y/n]: '
read response;

case $response in
    y|Y|'') echo -n '';;
    *) exit;;
esac

# create dirs if they dont exist
dirNames=$(printArray "${add[@]}" | awk -F '/' '{printf "'$HOME'/"; for(i=1;i<=NF-1;i++) printf $i"/"; print""}' | uniq)
mkdir -pv $dirNames

# copy new files over from "add" array
for fileName in ${add[@]};
do
    sudo cp $fileName "$HOME/$fileName"
done

# delete all individual files from "delete" array
for fileName in ${delete[@]};
do
    sudo rm -rf "$HOME/$fileName"
done

# remove empty directories after deleting individual files
baseDirs=$(printArray "${delete[@]}" | awk -F '/' '{printf "'$HOME'/"; for(i=1;i<=2;i++) printf $i"/"; print""}' | uniq | sed 's/\/$//g')
subDirs=$(printArray "${delete[@]}" | awk -F '/' '{printf "'$HOME'/"; for(i=1;i<=NF-1;i++) printf $i"/"; print""}' | uniq | sed 's/\/$//g')
for fileName in ${subDirs[@]};
do
    sudo rmdir "$fileName" 2>/dev/null
done

for fileName in ${baseDirs[@]};
do
    sudo rmdir "$fileName" 2>/dev/null
done

# only update modified files if they exist on local
for fileName in ${modify[@]};
do
    [ -e "$HOME/$fileName" ] && sudo cp "$fileName" "$HOME/$fileName"
done

